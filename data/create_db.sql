BEGIN;

DROP TABLE IF EXISTS "list", "card", "tag", "label", "card_has_tag", "card_has_label";

CREATE TABLE "list"(
    -- colonne id générée automatiquement pas la BDD
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" TEXT NOT NULL,
    "position" INTEGER NOT NULL DEFAULT 0,
    -- "timestamp" pour stocker date + heure, type TIMESTAMPTZ pour config fuseau horaire.
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    -- intialisation en NULL pour avoir valeur à l'enregistrement, même si pas d'update prévue
    "updated_at" TIMESTAMPTZ
);

CREATE TABLE "card"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "content" TEXT NOT NULL,
    "position" INTEGER NOT NULL DEFAULT 0,
    "color" TEXT,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ,
    -- convention de nommage pour les colonnes de référence : <nom de la table>_<colonne contenant la référence>
    "list_id" INTEGER NOT NULL REFERENCES "list"("id") ON DELETE CASCADE
);

CREATE TABLE "tag"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name" TEXT NOT NULL,
    "color" TEXT,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ
);

CREATE TABLE "card_has_tag"(
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "card_id" INTEGER NOT NULL REFERENCES "card" ON DELETE CASCADE,
    -- "ON DELETE CASCADE" pour supprimer automatiquement les cartes ou tags sans avoir à supprimer d'abord les associations
    "tag_id" INTEGER NOT NULL REFERENCES "tag" ON DELETE CASCADE,
    "created_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

INSERT INTO "list" ("id", "name", "position")
VALUES
(1, 'première liste', 1),
(2, 'deuxième liste', 0)
;

INSERT INTO "card" ("id", "content", "color", "list_id", "position")
VALUES
(1, 'carte 1', '#e0e0e0', 1, 1),
(2, 'carte 2', '#d3d3d3', 1, 0),
(3, 'carte 3', '#b7b7b7', 2, 0);

INSERT INTO "tag" ("id", "name", "color")
VALUES
(1, 'urgent', '#ff0000'),
(2, 'front', '#5cf263'),
(3, 'back', '#418ae2');

INSERT INTO "card_has_tag" ("card_id", "tag_id")
VALUES
(1, 1),
(1, 3),
(2, 2),
(3, 1),
(3, 3);

-- pour incrémentation auto depuis dernier enregistrement
SELECT setval('list_id_seq', (SELECT MAX(id) from "list"));
SELECT setval('card_id_seq', (SELECT MAX(id) from "card"));
SELECT setval('tag_id_seq', (SELECT MAX(id) from "tag"));


COMMIT;